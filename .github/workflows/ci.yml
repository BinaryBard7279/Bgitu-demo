name: Deploy IT_BGITU

on:
  push:
    branches: [ "main" ]

jobs:
  # 1. Проверка кода 
  check-code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check for missing migrations
        run: |
          export DATABASE_URL="sqlite:///./check.db"
          alembic check || echo "⚠️ ВНИМАНИЕ: Проверьте миграции!"

  # 2. Сборка и отправка образа
  build-and-push:
    needs: check-code  
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: binarybard7279/it-bgitu:latest

  # 2.5 НОВЫЙ ШАГ: Копируем обновленный docker-compose.yml на сервер
  update-configs:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Copy config files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          # Копируем docker-compose.yml (где volumes) и Caddyfile
          source: "docker-compose.yml,Caddyfile"
          target: "/root/it-bgitu"

  # 3. Деплой на сервер
  deploy:
    needs: update-configs # Ждем, пока обновятся конфиги
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            cd /root/it-bgitu
            
            # 1. Секреты (без изменений)
            echo "DB_USER=${{ secrets.DB_USER }}" > .env
            echo "DB_PASS=${{ secrets.DB_PASS }}" >> .env
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
            echo "DB_HOST=db" >> .env
            echo "DB_PORT=5432" >> .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            echo "ALGORITHM=${{ secrets.ALGORITHM }}" >> .env
            echo "ACCESS_TOKEN_EXPIRE_MINUTES=${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}" >> .env
            
            # 2. Деплой 
            # Теперь здесь будет использоваться НОВЫЙ docker-compose.yml с volumes
            docker compose pull
            docker compose up -d --remove-orphans
            
            # 3. Миграции и очистка
            sleep 5
            docker compose exec -T app alembic upgrade head
            docker image prune -f